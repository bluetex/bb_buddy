<!DOCTYPE html>
<html>
  <head>
    <title>MIDI Tempo Controls</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
              $(document).ready(function() {
                  var inputActive = false; // Flag to track if the input field is active

                  // Trigger setTempo() function on Enter/Return key press
                  $(document).on("keydown", function(e) {
                      if (e.keyCode === 13) {
                          setTempo();
                          e.preventDefault(); // Prevent the default behavior of Enter/Return key
                      }
                  });

      var keydownCount = 0;
      var isProcessingKeydown = false;
      var idleDelay = 250; // Adjust this value as needed

      // Trigger adjustTempo(-1) function on Down Arrow key press
      $(document).on("keydown", function(e) {
          if (e.keyCode === 40) {
              if (!inputActive && !isProcessingKeydown) {
                  adjustTempo(-1);
                  e.preventDefault(); // Prevent the default behavior of Down Arrow key
                  isProcessingKeydown = true;
                  keydownCount++;
                  setTimeout(commitKeydownValue, idleDelay);
              }
          }
      });

      // Trigger adjustTempo(1) function on Up Arrow key press
      $(document).on("keydown", function(e) {
          if (e.keyCode === 38) {
              if (!inputActive && !isProcessingKeydown) {
                  adjustTempo(1);
                  e.preventDefault(); // Prevent the default behavior of Up Arrow key
                  isProcessingKeydown = true;
                  keydownCount++;
                  setTimeout(commitKeydownValue, idleDelay);
              }
          }
      });

      function commitKeydownValue() {
          // Do something with the keydownCount value
          console.log("Keydown count:", keydownCount);
          keydownCount = 0; // Reset the count
          isProcessingKeydown = false; // Reset the flag
      }

                  // Set inputActive flag to true when the input field is focused
                  $("#new_tempo").on("focus", function() {
                      inputActive = true;
                  });

                  // Set inputActive flag to false when the input field loses focus
                  $("#new_tempo").on("blur", function() {
                      inputActive = false;
                  });

                  // Set focus back to the input field when a numeric key is pressed
                  $(document).on("keypress", function(e) {
                      if (isNumericKey(e.keyCode)) {
                          $("#new_tempo").focus();
                      }
                  });

                  // Helper function to check if a key code corresponds to a numeric key
                  function isNumericKey(keyCode) {
                      return (keyCode >= 48 && keyCode <= 57) || (keyCode >= 96 && keyCode <= 105);
                  }
              });

              function setTempo() {
                  var newTempo = document.getElementById("new_tempo").value;

                  // Send an AJAX POST request to the /set_tempo route
                  $.post("/set_tempo", { new_tempo: newTempo }, function(data) {
                      document.getElementById("current_tempo").innerText = data;
                      document.getElementById("new_tempo").value = "";
                      document.getElementById("new_tempo").blur(); // Remove focus from the input field
                  });
              }

              function adjustTempo(adjustment) {
                  // Send an AJAX POST request to the /adjust_tempo route
                  $.post("/adjust_tempo", { adjustment: adjustment }, function(data) {
                      document.getElementById("current_tempo").innerText = data;
                      document.getElementById("new_tempo").blur(); // Remove focus from the input field
                  });
              }
    </script>
    <style>
       .header {
          position: sticky;
          top: 0;
          background-color: #f1f1f1;
          padding: 0px;
          text-align: center;
          z-index: 999;
      }
    </style>

    <style>
      <!-- HTML !-->
      <button class="button-37" role="button">Button 37</button>

      /* CSS */
      .button-37 {
        background-color: #13aa52;
        border: 1px solid #13aa52;
        border-radius: 4px;
        box-shadow: rgba(0, 0, 0, .1) 0 2px 4px 0;
        box-sizing: border-box;
        color: #fff;
        cursor: pointer;
        font-family: "Akzidenz Grotesk BQ Medium", -apple-system, BlinkMacSystemFont, sans-serif;
        font-size: 16px;
        font-weight: 400;
        outline: none;
        outline: 0;
        padding: 10px 25px;
        text-align: center;
        transform: translateY(0);
        transition: transform 150ms, box-shadow 150ms;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
      }

      .button-37:hover {
        box-shadow: rgba(0, 0, 0, .15) 0 3px 9px 0;
        transform: translateY(-2px);
      }

      @media (min-width: 768px) {
        .button-37 {
          padding: 10px 30px;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <span id="Collection Select"><a href="/">Collection Select</a></span> |
      <span id="searchHeader"><a href="/search">Search Songs</a></span> |
      <span id="tempoHeader"><a href="/tempo_control">Tempo Control</a></span> |
      <span id="selectedGenreHeader"></span> |
      <span id="selectedSongHeader"></span> |
      <button id="sendToBBButton" onclick="sendToBeatBuddy()">
        Send to Beat Buddy
      </button>
      <div id="successMessage" style="display: none;">
        Data sent to Beat Buddy successfully!
      </div>
    </div>

    <h1>MIDI Tempo Controls</h1>
    <h2>Current Tempo: <span id="current_tempo">{{ current_tempo }}</span></h2>
    <div>
      <input
        type="number"
        id="new_tempo"
        placeholder="Tempo"
        min="40"
        max="300"
      />
      <button class="button-37" role="button" onclick="setTempo()">Set</button>
      <button class="button-37" role="button" onclick="adjustTempo(-1)">
        -
      </button>
      <button class="button-37" role="button" onclick="adjustTempo(1)">
        +
      </button>
    </div>
  </body>
</html>
